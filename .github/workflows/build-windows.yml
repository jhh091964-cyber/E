name: Build Windows EXE

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    paths:
      - '**.py'
      - '**.spec'
      - '**.bat'
      - 'requirements.txt'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PySide6==6.6.0
        pip install requests==2.31.0
        pip install paramiko==3.4.0
        pip install PySocks>=1.7.1
        pip install pyinstaller
        pip install certifi
        
    - name: Verify imports
      run: |
        python -c "import account_store; print('âœ“ account_store ok')"
        python -c "import account_card; print('âœ“ account_card ok')"
        python -c "import sender_manager; print('âœ“ sender_manager ok')"
        python -c "import template_manager; print('âœ“ template_manager ok')"
        python -c "import variable_parser; print('âœ“ variable_parser ok')"
        
    - name: Create necessary directories
      run: |
        if not exist "config" mkdir config
        if not exist "data" mkdir data
        if not exist "logs" mkdir logs
        if not exist "templates" mkdir templates
        echo {} > config\accounts.json
        echo {} > data\apis.json
        
    - name: Build EXE with PyInstaller
      run: |
        pyinstaller --clean --noconfirm main_windows.spec
        
    - name: Verify build
      run: |
        echo "=== dist directory structure ==="
        dir dist\main
        echo ""
        echo "=== Checking main.exe ==="
        if exist "dist\main\main.exe" (
            echo "âœ“ main.exe found"
            dir dist\main\main.exe
        ) else (
            echo "âœ— main.exe NOT found"
            exit 1
        )
        
    - name: Create distribution ZIP
      run: |
        cd dist
        powershell -Command "Compress-Archive -Path main\* -DestinationPath mail_sender_windows.zip -Force"
        cd ..
        echo "=== ZIP file info ==="
        dir dist\mail_sender_windows.zip
        
    - name: Calculate SHA256
      run: |
        certutil -hashfile dist\mail_sender_windows.zip SHA256
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: mail-sender-windows-zip
        path: dist/mail_sender_windows.zip
        retention-days: 30
        
    - name: Upload EXE artifact
      uses: actions/upload-artifact@v4
      with:
        name: mail-sender-exe
        path: dist/main/main.exe
        retention-days: 30
        
    - name: Create Release Summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ Output: \`dist/mail_sender_windows.zip\`" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ Unzip and run \`main/main.exe\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Download Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "Artifacts are available in the Actions tab for 30 days." >> $GITHUB_STEP_SUMMARY
